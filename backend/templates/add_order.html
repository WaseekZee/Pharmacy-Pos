<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Add Order</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .product-row { margin-bottom: 15px; }
  </style>
</head>
<body class="p-4">
  <div class="container">
    <h2 class="mb-4">Place Order</h2>

    <form method="POST" action="{{ url_for('order_bp.add_order') }}">
      <div class="row mb-3">
        <div class="col">
          <label for="date" class="form-label">Order Date</label>
          <input type="date" class="form-control" name="date" id="date" required>
        </div>

        <div class="col">
          <label for="payment_type" class="form-label">Payment Type</label>
          <select name="payment_type" class="form-select" required>
            <option value="Cash" selected>Cash</option>
            <option value="Card">Card</option>
            <option value="Online">Online</option>
          </select>
        </div>

        <div class="col">
          <label for="customer_id" class="form-label">Customer</label>
          <div class="input-group">
            <select name="customer_id" id="customer_id" class="form-select" required>
              {% for c in customers %}
                <option value="{{ c.CustomerID }}" {% if c.CustomerID == 7 %}selected{% endif %}>
                  {{ c.Name }} ({{ c.Phone }})
                </option>
              {% endfor %}
            </select>

            <button class="btn btn-outline-primary" type="button" data-bs-toggle="modal" data-bs-target="#addCustomerModal">+</button>
          </div>
        </div>
      </div>

      <h5 class="mt-4">Order Items</h5>
      <div id="product-list">
        <div class="row product-row">
          <div class="col-4">
            <label class="form-label">Product</label>
            <select name="product_id[]" id="product_0" class="form-select product-select" onchange="loadStocks(this)" required>
              <option value="">-- Select --</option>
              {% for p in products %}
                <option value="{{ p.ProductID }}">{{ p.ProductName }} - {{ p.Name }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="col-3">
            <label class="form-label">Stock</label>
            <select name="stock_id[]" id="stock_0" class="form-select stock-select" onchange="updatePrice(this)" required>
              <option value="">-- Select Stock --</option>
            </select>
          </div>

          <div class="col-2">
            <label class="form-label">Qty</label>
            <input type="number" name="quantity[]" id="qty_0" class="form-control qty-input" min="1" value="1" onchange="recalculateTotals()">
          </div>

          <div class="col-2">
            <label class="form-label">Price</label>
            <input type="text" id="price_0" class="form-control price-display" readonly>
          </div>

          <div class="col-1 d-flex align-items-end">
            <button type="button" class="btn btn-danger btn-sm" onclick="removeRow(this)">X</button>
          </div>
        </div>
      </div>

      <button type="button" class="btn btn-secondary my-3" onclick="addRow()">+ Add Product</button>

      <div class="row mb-3">
        <div class="col-md-4 offset-md-8">
          <label class="form-label">Total Amount</label>
          <input type="text" id="total_amount" name="total_amount" class="form-control" readonly>
        </div>
      </div>

      <button type="submit" class="btn btn-primary w-100">Submit Order</button>
    </form>
  </div>

  <!-- Add Customer Modal -->
  <div class="modal fade" id="addCustomerModal" tabindex="-1" aria-labelledby="addCustomerLabel" aria-hidden="true">
    <div class="modal-dialog">
      <form id="addCustomerForm">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="addCustomerLabel">Add New Customer</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label for="new_customer_name" class="form-label">Name</label>
              <input type="text" class="form-control" id="new_customer_name" required>
            </div>
            <div class="mb-3">
              <label for="new_customer_phone" class="form-label">Phone</label>
              <input type="text" class="form-control" id="new_customer_phone" required>
            </div>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-success">Add</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <script>
    function loadStocks(productSelect) {
      const productId = productSelect.value;
      const row = productSelect.closest('.product-row');
      const stockSelect = row.querySelector('.stock-select');
      const priceDisplay = row.querySelector('.price-display');

      stockSelect.innerHTML = '<option>Loading...</option>';
      priceDisplay.value = '';

      fetch(`/orders/get_stocks/${productId}`)
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            stockSelect.innerHTML = '<option value="">-- Select --</option>';
            data.stocks.forEach(s => {
              stockSelect.innerHTML += `
                <option value="${s.StockID}" data-price="${s.SellingPrice}">
                  Stock#${s.StockID} | Qty: ${s.Quantity} | Rs. ${s.SellingPrice}
                </option>`;
            });
          } else {
            stockSelect.innerHTML = '<option>Error loading</option>';
          }
        })
        .catch(() => {
          stockSelect.innerHTML = '<option>Error loading</option>';
        });
    }

    function updatePrice(stockSelect) {
      const row = stockSelect.closest('.product-row');
      const price = stockSelect.selectedOptions[0]?.getAttribute('data-price') || 0;
      row.querySelector('.price-display').value = price;
      recalculateTotals();
    }

    function recalculateTotals() {
      let total = 0;
      document.querySelectorAll('#product-list .product-row').forEach(row => {
        const price = parseFloat(row.querySelector('.price-display').value) || 0;
        const qty = parseInt(row.querySelector('.qty-input').value) || 0;
        total += price * qty;
      });
      document.getElementById('total_amount').value = total.toFixed(2);
    }

    let rowCount = 1;

    function addRow() {
      const firstRow = document.querySelector('.product-row');
      const newRow = firstRow.cloneNode(true);

      newRow.querySelectorAll('select, input, label').forEach(el => {
        if (el.tagName === 'LABEL') {
          const field = el.htmlFor;
          if (field) el.htmlFor = field.split('_')[0] + '_' + rowCount;
        } else if (el.id) {
          const base = el.id.split('_')[0];
          el.id = base + '_' + rowCount;
        }

        if (el.classList.contains('product-select')) {
          el.selectedIndex = 0;
        } else if (el.classList.contains('stock-select')) {
          el.innerHTML = '<option value="">-- Select Stock --</option>';
        } else if (el.classList.contains('qty-input')) {
          el.value = 1;
        } else if (el.classList.contains('price-display')) {
          el.value = '';
        }
      });

      document.getElementById('product-list').appendChild(newRow);
      rowCount++;
    }

    function removeRow(btn) {
      const rows = document.querySelectorAll('.product-row');
      if (rows.length > 1) {
        btn.closest('.product-row').remove();
        recalculateTotals();
      } else {
        alert("At least one product is required.");
      }
    }

    document.addEventListener("DOMContentLoaded", function () {
      const today = new Date();
      const localDate = today.getFullYear() + '-' + 
            String(today.getMonth() + 1).padStart(2, '0') + '-' + 
            String(today.getDate()).padStart(2, '0');
      document.getElementById("date").value = localDate;
    });

    document.getElementById("addCustomerForm").addEventListener("submit", function (e) {
      e.preventDefault();

      const name = document.getElementById("new_customer_name").value;
      const phone = document.getElementById("new_customer_phone").value;

      fetch("/orders/add_customer", {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded"
        },
        body: new URLSearchParams({ name: name, phone: phone })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          const select = document.getElementById("customer_id");
          const option = new Option(`${data.name} (${phone})`, data.customer_id, true, true);
          select.add(option);

          const modal = bootstrap.Modal.getInstance(document.getElementById('addCustomerModal'));
          modal.hide();
          document.getElementById("addCustomerForm").reset();
        } else {
          alert("Error: " + data.message);
        }
      })
      .catch(err => alert("Request failed"));
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
